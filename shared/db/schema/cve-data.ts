import { relations } from "drizzle-orm";
import {
  pgTable,
  uuid,
  text,
  timestamp,
  boolean,
  numeric,
  integer,
  jsonb
} from "drizzle-orm/pg-core";
import { createInsertSchema } from "drizzle-zod";

// Global APIs Table - API Configuration and Metadata
export const globalApis = pgTable("global_apis", {
  id: uuid("id").defaultRandom().primaryKey(),

  // API Configuration and Metadata
  name: text("name").notNull(), // e.g., "NIST National Vulnerability Database"
  slug: text("slug").notNull().unique(), // e.g., "nist-nvd"
  providerType: text("provider_type").notNull(), // "nist", "cisa", "mitre"
  baseUrl: text("base_url").notNull(), // API endpoint base URL
  authConfig: jsonb("auth_config"), // Authentication configuration
  rateLimitConfig: jsonb("rate_limit_config"), // Rate limiting settings

  // Status
  status: text("status").notNull().default("active"), // "active", "inactive", "error"
  isActive: boolean("is_active").notNull().default(true),

  // Timestamps
  lastSyncAt: timestamp("last_sync_at"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});

// CVE Data Table - Complete vulnerability information
export const cveData = pgTable("cve_data", {
  id: uuid("id").defaultRandom().primaryKey(),

  // CVE Identification
  cveId: text("cve_id").notNull().unique(), // e.g., "CVE-2023-44487"
  apiId: uuid("api_id").notNull().references(() => globalApis.id),

  // Severity and Scoring
  severityLevel: text("severity_level"), // "Critical", "High", "Medium", "Low"
  severityScore: integer("severity_score"), // 0-100 scale
  cvssScore: numeric("cvss_score", { precision: 3, scale: 1 }), // 0-10 scale

  // Content and Description
  title: text("title").notNull(),
  overview: text("overview"),
  backgroundDetails: text("background_details"),
  threatDetails: text("threat_details"),
  mitigationDetails: text("mitigation_details"),

  // Product and Classification
  affectedProducts: jsonb("affected_products"), // JSON array of affected products
  threatCategories: jsonb("threat_categories"), // JSON object of threat classifications
  problemTypes: jsonb("problem_types"), // Array of weakness types (CWE)
  keywords: jsonb("keywords"), // Array of search keywords

  // Date Information
  publishDate: timestamp("publish_date"),
  lastModifiedDate: timestamp("last_modified_date"),
  nvdPublishedDate: timestamp("nvd_published_date"),
  ingestedAt: timestamp("ingested_at").defaultNow().notNull(),

  // CISA KEV Specific
  isKev: boolean("is_kev").default(false),
  kevDateAdded: timestamp("kev_date_added"),
  kevDueDate: timestamp("kev_due_date"),
  requiredAction: text("required_action"),
  knownRansomwareUse: boolean("known_ransomware_use").default(false),

  // Analysis Status
  awaitingEnrichment: boolean("awaiting_enrichment").default(false),
  analysisVersion: text("analysis_version"), // e.g., "cve-v1.0"
  vulnStatus: text("vuln_status"),

  // References and Sources
  officialUrls: jsonb("official_urls"), // JSON object with government source URLs
  references: jsonb("references"), // JSON array of reference URLs
  author: text("author"),
  sourceMetadata: jsonb("source_metadata"), // Additional source-specific data

  // Display and UI
  isNew: boolean("is_new").default(false), // For "NEW" badge (computed from publish_date)
  showAnalysisBadge: boolean("show_analysis_badge").default(false),
  showKevBadge: boolean("show_kev_badge").default(false),

  // Metadata
  dataVersion: text("data_version"), // Data format version for migrations
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});

// Relations
export const globalApisRelations = relations(globalApis, ({ many }) => ({
  cveData: many(cveData)
}));

export const cveDataRelations = relations(cveData, ({ one }) => ({
  api: one(globalApis, {
    fields: [cveData.apiId],
    references: [globalApis.id]
  })
}));

// Insert schemas for validation (following existing pattern)
export const insertGlobalApiSchema = createInsertSchema(globalApis).omit({
  createdAt: true,
  updatedAt: true
});

export const insertCveDataSchema = createInsertSchema(cveData).omit({
  createdAt: true,
  updatedAt: true,
  ingestedAt: true
});

// Type exports (following existing pattern)
export type GlobalApi = typeof globalApis.$inferSelect;
export type NewGlobalApi = typeof globalApis.$inferInsert;
export type CveData = typeof cveData.$inferSelect;
export type NewCveData = typeof cveData.$inferInsert;